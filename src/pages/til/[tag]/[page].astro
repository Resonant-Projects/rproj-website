---
import Layout from '~/layouts/PageLayout.astro';
import TilFilterSheet from '~/components/til/TilFilterSheet.astro';
import TilViewToggle from '~/components/til/TilViewToggle.astro';
import TilSocialFeed from '~/components/til/TilSocialFeed.astro';
import Pagination from '~/components/common/Pagination.astro';
import { getCollection, type CollectionEntry } from 'astro:content';
import { findTilTags } from '~/utils/til';

type TilEntry = CollectionEntry<'til'>;

export const prerender = true;

export async function getStaticPaths({
  paginate,
}: {
  paginate: (data: TilEntry[], options: { params: Record<string, string>; pageSize: number }) => unknown[];
}) {
  const allEntries = await getCollection('til');
  const allTags = await findTilTags();

  return allTags.flatMap(tag => {
    const filteredEntries = allEntries.filter((entry: CollectionEntry<'til'>) => {
      const entryTags = entry.data.tags || [];
      return entryTags.some((entryTag: string) => entryTag.toLowerCase().replace(/\s+/g, '-') === tag.slug);
    });

    if (filteredEntries.length > 0) {
      return paginate(filteredEntries, {
        params: { tag: tag.slug },
        pageSize: 10,
      });
    }

    return [];
  });
}

const { page } = Astro.props as {
  page: {
    data: TilEntry[];
    total: number;
    size: number;
    url: { prev?: string; next?: string; first?: string; last?: string };
  };
};
const params = Astro.params as { tag: string; page: string };

const allTags = await findTilTags();
const currentTag = allTags.find(tag => tag.slug === params.tag);

const allEntries = await getCollection('til');
const scopedEntries = allEntries.filter((entry: CollectionEntry<'til'>) => {
  const entryTags = entry.data.tags || [];
  return entryTags.some((entryTag: string) => entryTag.toLowerCase().replace(/\s+/g, '-') === params.tag);
});

const totalPages = Math.ceil(page.total / page.size);
const currentPage = Number.parseInt(params.page, 10);

const title = currentTag ? `TIL: #${currentTag.title}` : 'Today I Learned';
const serializedEntries = scopedEntries.map(entry => ({
  id: entry.id,
  slug: entry.slug,
  title: entry.data.title || '',
  description: entry.data.description || '',
  tags: entry.data.tags || [],
  date: entry.data.date.toISOString(),
}));
---

<Layout>
  <div class="mx-auto max-w-7xl px-6 py-8 md:px-8" data-til-page="tag">
    <div class="mb-8">
      <h1 class="leading-tighter mb-4 text-3xl font-bold tracking-tighter md:mb-0 md:text-4xl">
        {title}
        <span data-search-query-display class="hidden text-primary"></span>
        <span class="text-muted-foreground text-lg font-normal">(Page {currentPage} of {totalPages})</span>
      </h1>

      {
        currentTag && <p class="text-muted-foreground mb-4">{page.total} entries tagged with #{currentTag.title}</p>
      }
      <p class="text-muted-foreground mt-2 hidden text-sm" data-search-summary></p>
    </div>

    <div class="mb-8 flex flex-col gap-4 md:flex-row md:items-center md:justify-between">
      <TilFilterSheet tags={allTags} selectedTag={currentTag?.slug || undefined} />
      <TilViewToggle currentView="feed" />
    </div>

    <div data-til-default-content>
      {
        page.data.length > 0 ? (
          <div>
            <TilSocialFeed entries={page.data} />
            <div class="mt-8" data-til-pagination>
              <Pagination
                currentPage={currentPage}
                lastPage={totalPages}
                prevUrl={page.url.prev}
                nextUrl={page.url.next}
                firstUrl={page.url.first}
                lastUrl={page.url.last}
                baseUrl={`/til/${params.tag}`}
                queryParams={Astro.url.searchParams}
              />
            </div>
          </div>
        ) : (
          <div class="py-12 text-center">
            <h2 class="text-muted-foreground mb-2 text-xl font-semibold">No entries found</h2>
            <p class="text-muted-foreground mb-4">No entries found for this tag.</p>
            <a href="/til/all/1" class="mt-4 inline-block text-primary hover:text-accent">
              View all entries
            </a>
          </div>
        )
      }
    </div>

    <div class="hidden" data-til-search-results></div>

    <script type="application/json" is:inline data-til-dataset set:html={JSON.stringify(serializedEntries)} />
  </div>

  <script>
    import { initializeTilListing } from '~/scripts/til-listing';

    initializeTilListing();
    document.addEventListener('astro:page-load', initializeTilListing);
  </script>
</Layout>
