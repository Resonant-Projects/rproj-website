---
import type { GetStaticPaths } from 'astro';
import type { CollectionEntry } from 'astro:content';

import Layout from '~/layouts/PageLayout.astro';
import { getCollection } from 'astro:content';
import { getPermalink } from '~/utils/permalinks';
import { getNotionEntryTitle } from '~/utils/notion';
import { getResourceCanonicalSlug, getResourceLegacySlug } from '~/utils/resource-slug';

export const prerender = true;

type ResourceEntry = CollectionEntry<'resources'>;
type ResourceRender = { rendered?: { html?: string } };

type ResourceData = {
  Name?: string;
  Source?: string;
  'User Defined URL'?: string;
  Tags?: string[];
  Type?: string[];
  Category?: string[];
  Keywords?: string[];
  'AI summary'?: string;
};

const toStringArray = (value: string | string[] | undefined): string[] => {
  if (Array.isArray(value)) return value.filter(Boolean).map(String);
  if (typeof value === 'string' && value.trim()) return [value];
  return [];
};

export const getStaticPaths = (async () => {
  const entries = await getCollection('resources');
  const legacyCounts = new Map<string, number>();

  entries.forEach(entry => {
    const legacySlug = getResourceLegacySlug(entry);
    legacyCounts.set(legacySlug, (legacyCounts.get(legacySlug) ?? 0) + 1);
  });

  const paths: Array<{ params: { slug: string }; props: { entry?: ResourceEntry; redirectTo?: string } }> = [];

  entries.forEach(entry => {
    const canonicalSlug = getResourceCanonicalSlug(entry);
    const legacySlug = getResourceLegacySlug(entry);

    paths.push({
      params: { slug: canonicalSlug },
      props: { entry },
    });

    if (legacySlug !== canonicalSlug && (legacyCounts.get(legacySlug) ?? 0) === 1) {
      paths.push({
        params: { slug: legacySlug },
        props: { redirectTo: canonicalSlug },
      });
    }
  });

  return paths;
}) satisfies GetStaticPaths;

const { entry, redirectTo } = Astro.props as {
  entry?: ResourceEntry;
  redirectTo?: string;
};

if (redirectTo) {
  return Astro.redirect(`/resources/${redirectTo}`, 301);
}

if (!entry) {
  throw new Error('Missing resource entry for resources/[slug] route');
}

const data = entry.data as ResourceData;
const title = data.Name || getNotionEntryTitle(entry) || 'Resource';
const description = data['AI summary'] || data.Source || '';
const canonicalSlug = getResourceCanonicalSlug(entry);
const canonical = getPermalink(`/resources/${canonicalSlug}`, 'post');

const types = toStringArray(data.Type);
const categories = toStringArray(data.Category);
const tags = toStringArray(data.Tags);
const keywords = toStringArray(data.Keywords);
const sourceUrl = data.Source || data['User Defined URL'];

const renderedHtml = (entry as unknown as ResourceRender).rendered?.html;
---

<Layout metadata={{ title, description, canonical }}>
  <article class="container prose prose-gray mx-auto max-w-3xl px-4 py-8 dark:prose-invert" data-pagefind-body>
    <h1 class="mb-4">{title}</h1>

    {
      description && (
        <details class="mb-6 rounded-lg border bg-white/60 p-4 dark:bg-gray-900/60">
          <summary class="cursor-pointer select-none text-base font-semibold">AI summary</summary>
          <div class="mt-3 text-base leading-relaxed">{description}</div>
        </details>
      )
    }

    {renderedHtml ? <div class="notion-content mt-10" set:html={renderedHtml} /> : null}

    <footer class="mt-10 space-y-4">
      {
        types.length > 0 && (
          <p class="mt-4 text-sm">
            <strong>Type:</strong> {types.join(', ')}
          </p>
        )
      }
      {
        categories.length > 0 && (
          <p class="mt-2 text-sm">
            <strong>Category:</strong> {categories.join(', ')}
          </p>
        )
      }
      {
        tags.length > 0 && (
          <p class="mt-2 text-sm">
            <strong>Tags:</strong> {tags.join(', ')}
          </p>
        )
      }

      {
        sourceUrl && (
          <p class="text-sm">
            <strong>Source:</strong>{' '}
            <a class="underline underline-offset-2" href={sourceUrl} rel="noopener noreferrer" target="_blank">
              {sourceUrl}
            </a>
          </p>
        )
      }

      {
        keywords.length > 0 && (
          <div class="flex flex-wrap gap-2">
            {keywords.map((kw: string) => (
              <span class="inline-flex items-center rounded-full bg-brand-100 px-3 py-1 text-xs font-medium text-brand-800 dark:bg-brand-900/40 dark:text-brand-100">
                {kw}
              </span>
            ))}
          </div>
        )
      }
    </footer>
  </article>
</Layout>
