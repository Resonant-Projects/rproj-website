---
import Layout from '~/layouts/PageLayout.astro';
import RrSearch from '~/components/resources/ResourceSearch.astro';
import RrFilterSheet from '~/components/resources/ResourceFilterSheet.astro';
import ResourceGrid from '~/components/resources/ResourceGrid.astro';
import Pagination from '~/components/common/Pagination.astro';
import { getCollection, type CollectionEntry } from 'astro:content';
import { findResourceCategories, findResourceTypes } from '~/utils/resources';
import { getNotionEntryTitle } from '~/utils/notion';
import { getResourceCanonicalSlug } from '~/utils/resource-slug';

type ResourceEntry = CollectionEntry<'resources'>;

export const prerender = true;

const toStringArray = (value: string | string[] | undefined): string[] => {
  if (Array.isArray(value)) return value.filter(Boolean).map(String);
  if (typeof value === 'string' && value.trim()) return [value];
  return [];
};

const serializeResourceEntry = (entry: ResourceEntry) => {
  const data = entry.data;
  return {
    id: entry.id,
    title: data.Name || getNotionEntryTitle(entry),
    summary: data['AI summary'] || '',
    categories: toStringArray(data.Category),
    types: toStringArray(data.Type),
    href: `/resources/${getResourceCanonicalSlug(entry)}`,
    source: data.Source || data['User Defined URL'] || '',
  };
};

export async function getStaticPaths({
  paginate,
}: {
  paginate: (data: ResourceEntry[], options: { params: Record<string, string>; pageSize: number }) => unknown[];
}) {
  const allEntries = await getCollection('resources');
  const allCategories = await findResourceCategories();
  const allTypes = await findResourceTypes();

  const paths = [];

  for (const category of allCategories) {
    for (const type of allTypes) {
      const filteredEntries = allEntries.filter((entry: ResourceEntry) => {
        const entryCategories = entry.data.Category;
        const entryTypes = entry.data.Type;

        const categoryMatch = Array.isArray(entryCategories)
          ? entryCategories.includes(category)
          : entryCategories === category;
        const typeMatch = Array.isArray(entryTypes) ? entryTypes.includes(type) : entryTypes === type;

        return categoryMatch && typeMatch;
      });

      if (filteredEntries.length > 0) {
        paths.push(
          ...paginate(filteredEntries, {
            params: { category, type },
            pageSize: 12,
          })
        );
      } else {
        paths.push({
          params: { category, type, page: '1' },
          props: {
            page: {
              data: [],
              url: {
                current: 1,
                prev: undefined,
                next: undefined,
                first: undefined,
                last: undefined,
              },
              size: 12,
              total: 0,
            },
          },
        });
      }
    }
  }

  return paths;
}

const { page } = Astro.props as {
  page: {
    data: ResourceEntry[];
    total: number;
    size: number;
    url: { prev?: string; next?: string; first?: string; last?: string };
  };
};
const params = Astro.params as { category: string; type: string; page: string };

const decodedCategory = decodeURIComponent(params.category);
const decodedType = decodeURIComponent(params.type);

const allEntries = await getCollection('resources');
const scopedEntries = allEntries.filter((entry: ResourceEntry) => {
  const entryCategories = entry.data.Category;
  const entryTypes = entry.data.Type;

  const categoryMatch = Array.isArray(entryCategories)
    ? entryCategories.includes(decodedCategory)
    : entryCategories === decodedCategory;
  const typeMatch = Array.isArray(entryTypes) ? entryTypes.includes(decodedType) : entryTypes === decodedType;

  return categoryMatch && typeMatch;
});
const serializedEntries = scopedEntries.map(serializeResourceEntry);

const allCategories = await findResourceCategories();
const allTypes = await findResourceTypes();

const totalPages = Math.max(1, Math.ceil(page.total / page.size));
let currentPage = Number.parseInt(params.page, 10);
if (Number.isNaN(currentPage) || currentPage < 1) currentPage = 1;
if (currentPage > totalPages) currentPage = totalPages;

const title = 'RR Resources';
const pageTitle = `${title}: ${decodedCategory} - ${decodedType} (Page ${currentPage} of ${totalPages})`;
const seoDescription = `Resources in the ${decodedCategory} category of type ${decodedType}. ${page.total} resources found.`;
const canonical = new URL(
  `/resources/category/${params.category}/type/${params.type}/${currentPage}`,
  Astro.site ?? 'https://www.resonantprojects.art'
).toString();
---

<Layout
  metadata={{
    title: pageTitle,
    description: seoDescription,
    canonical,
  }}
>
  <div class="mx-auto max-w-7xl px-6 py-8 md:px-8" data-resources-page>
    <div class="mb-8">
      <div class="flex items-center justify-between">
        <div>
          <h1 class="leading-tighter text-3xl font-bold tracking-tighter md:text-4xl">
            {title}: {decodedCategory} - {decodedType}
            <span data-search-query-display class="hidden text-primary"></span>
            <span class="text-muted-foreground text-lg font-normal">(Page {currentPage} of {totalPages})</span>
          </h1>
          <p class="text-muted-foreground mt-2">
            {page.total} resources in the {decodedCategory} category of type {decodedType}
          </p>
          <p class="text-muted-foreground mt-2 hidden text-sm" data-search-summary></p>
        </div>
        <RrFilterSheet
          categories={allCategories}
          types={allTypes}
          selectedCategory={decodedCategory || undefined}
          selectedType={decodedType || undefined}
        />
      </div>
    </div>

    <div class="mb-8">
      <RrSearch />
    </div>

    <div data-resources-default-content>
      {
        page.data.length > 0 ? (
          <div>
            <ResourceGrid entries={page.data} />
            <div class="mt-8" data-resources-pagination>
              <Pagination
                currentPage={currentPage}
                lastPage={totalPages}
                prevUrl={page.url.prev}
                nextUrl={page.url.next}
                firstUrl={page.url.first}
                lastUrl={page.url.last}
                baseUrl={`/resources/category/${encodeURIComponent(decodedCategory)}/type/${encodeURIComponent(decodedType)}`}
                queryParams={Astro.url.searchParams}
              />
            </div>
          </div>
        ) : (
          <div class="py-16 text-center">
            <div class="mx-auto max-w-md">
              <h2 class="mb-2 text-2xl font-semibold text-foreground">No resources in this combination</h2>
              <p class="text-muted-foreground mb-6">
                We don't have any resources in the {decodedCategory} category of type {decodedType} yet.
              </p>
              <div class="flex flex-col justify-center gap-3 sm:flex-row">
                <a
                  href={`/resources/category/${encodeURIComponent(decodedCategory)}/1`}
                  class="inline-flex items-center justify-center rounded-md bg-primary px-4 py-2 text-primary-foreground transition-colors hover:bg-primary/90"
                >
                  View all {decodedCategory} resources
                </a>
                <a
                  href={`/resources/type/${encodeURIComponent(decodedType)}/1`}
                  class="inline-flex items-center justify-center rounded-md bg-secondary px-4 py-2 text-secondary-foreground transition-colors hover:bg-secondary/90"
                >
                  View all {decodedType} resources
                </a>
              </div>
            </div>
          </div>
        )
      }
    </div>

    <div class="hidden" data-resources-search-results></div>

    <script type="application/json" is:inline data-resources-dataset set:html={JSON.stringify(serializedEntries)} />
  </div>

  <script>
    import { initializeResourcesListing } from '~/scripts/resources-listing';

    initializeResourcesListing();
    document.addEventListener('astro:page-load', initializeResourcesListing);
  </script>
</Layout>
