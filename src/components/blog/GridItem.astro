---
import { APP_BLOG } from 'astrowind:config';
import type { Post } from '~/types';

import Image from '~/components/common/Image.astro';
import { Icon } from 'astro-icon/components';

import { findImage } from '~/utils/images';
import { getPermalink } from '~/utils/permalinks';

export interface Props {
  post: Post;
}

const { post } = Astro.props;
const image = await findImage(post.image);

const link = APP_BLOG?.post?.isEnabled ? getPermalink(post.permalink, 'post') : '';

// Determine if this is a newsletter based on tags
const isNewsletter = post.tags?.some((tag) => tag.slug === 'newsletter');
const categoryLabel = isNewsletter ? 'Newsletter' : post.category?.title || 'Article';
const categoryIcon = isNewsletter ? 'tabler:mail' : 'tabler:file-text';

// Format date
const formattedDate = post.publishDate
  ? new Intl.DateTimeFormat('en-US', { month: 'short', year: 'numeric' }).format(new Date(post.publishDate))
  : '';
---

<article class="intersect-once intersect-quarter mb-6 transition">
  <div class="relative mb-6 overflow-hidden rounded-sm bg-muted shadow-lg dark:bg-muted md:h-64">
    {
      image ? (
        link ? (
          <a href={link} class="group block h-full">
            <Image
              src={image}
              class="w-full rounded-sm bg-muted shadow-lg transition-transform duration-300 group-hover:scale-105 dark:bg-muted md:h-full"
              widths={[400, 900]}
              width={400}
              sizes="(max-width: 900px) 400px, 900px"
              alt={post.title}
              aspectRatio="16:9"
              layout="cover"
              loading="lazy"
              decoding="async"
            />
            {/* Category badge and date overlay */}
            <div class="absolute inset-0 bg-gradient-to-t from-black/60 via-transparent to-transparent" />
            <div class="absolute bottom-3 left-3 right-3 flex items-end justify-between">
              <span class="bg-accent/90 text-accent-foreground inline-flex items-center gap-1.5 rounded-full px-3 py-1 text-xs font-semibold">
                <Icon name={categoryIcon} class="h-3.5 w-3.5" />
                {categoryLabel}
              </span>
              {formattedDate && (
                <span class="rounded bg-black/50 px-2 py-1 text-xs font-medium text-white">{formattedDate}</span>
              )}
            </div>
          </a>
        ) : (
          <div class="relative h-full">
            <Image
              src={image}
              class="w-full rounded-sm bg-muted shadow-lg md:h-full"
              widths={[400, 900]}
              width={400}
              sizes="(max-width: 900px) 400px, 900px"
              alt={post.title}
              aspectRatio="16:9"
              layout="cover"
              loading="lazy"
              decoding="async"
            />
            {/* Category badge and date overlay */}
            <div class="absolute inset-0 bg-gradient-to-t from-black/60 via-transparent to-transparent" />
            <div class="absolute bottom-3 left-3 right-3 flex items-end justify-between">
              <span class="bg-accent/90 text-accent-foreground inline-flex items-center gap-1.5 rounded-full px-3 py-1 text-xs font-semibold">
                <Icon name={categoryIcon} class="h-3.5 w-3.5" />
                {categoryLabel}
              </span>
              {formattedDate && (
                <span class="rounded bg-black/50 px-2 py-1 text-xs font-medium text-white">{formattedDate}</span>
              )}
            </div>
          </div>
        )
      ) : (
        /* Fallback for posts without images - styled placeholder */
        <div class="flex h-full flex-col items-center justify-center bg-gradient-to-br from-accent/20 via-muted to-accent/10 p-6">
          <Icon name={categoryIcon} class="mb-3 h-12 w-12 text-accent/60" />
          <span class="bg-accent/90 text-accent-foreground inline-flex items-center gap-1.5 rounded-full px-3 py-1 text-xs font-semibold">
            {categoryLabel}
          </span>
          {formattedDate && <span class="mt-3 text-sm font-medium text-muted-foreground">{formattedDate}</span>}
        </div>
      )
    }
  </div>

  <h3 class="mb-2 font-heading text-xl font-bold leading-tight dark:text-foreground sm:text-2xl">
    {
      link ? (
        <a class="inline-block transition duration-200 ease-in hover:text-accent" href={link}>
          {post.title}
        </a>
      ) : (
        post.title
      )
    }
  </h3>

  <p class="text-foreground/70 text-lg">{post.excerpt}</p>
</article>
