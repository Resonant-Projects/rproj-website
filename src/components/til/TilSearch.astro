---
import { SEARCH_PARAM } from '~/utils/search-routing';

export interface Props {
  class?: string;
  placeholder?: string;
}

const { class: className = '', placeholder = 'Search TIL entries...' } = Astro.props;
---

<div class={`til-search ${className}`}>
  <form id="til-search-form" class="relative" data-til-search-form>
    <input
      type="text"
      id="til-search-input"
      name={SEARCH_PARAM}
      placeholder={placeholder}
      class="bg-muted/50 placeholder-muted-foreground w-full rounded-md border border-border px-4 py-3 text-foreground focus:outline-none focus:ring-2 focus:ring-primary"
      data-til-search-input
    />
    <button
      type="submit"
      class="text-muted-foreground absolute right-3 top-1/2 -translate-y-1/2 transform transition-colors hover:text-primary"
      aria-label="Search"
    >
      <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
        <path
          stroke-linecap="round"
          stroke-linejoin="round"
          stroke-width="2"
          d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
      </svg>
    </button>
  </form>
</div>

<script>
  import { SEARCH_PARAM } from '~/utils/search-routing';

  const initTilSearch = () => {
    const searchForm = document.querySelector<HTMLFormElement>('[data-til-search-form]');
    const searchInput = searchForm?.querySelector<HTMLInputElement>('[data-til-search-input]');

    if (!searchForm || !searchInput || searchForm.dataset.initialized === 'true') {
      return;
    }

    searchForm.dataset.initialized = 'true';

    const queryParam = new URLSearchParams(window.location.search).get(SEARCH_PARAM);
    if (queryParam) {
      searchInput.value = queryParam;
    }

    searchForm.addEventListener('submit', e => {
      e.preventDefault();
      const url = new URL(window.location.href);
      const query = searchInput.value.trim();

      if (query) {
        url.searchParams.set(SEARCH_PARAM, query);
      } else {
        url.searchParams.delete(SEARCH_PARAM);
      }

      window.location.href = `${url.pathname}${url.search ? `?${url.searchParams.toString()}` : ''}`;
    });
  };

  document.addEventListener('astro:page-load', initTilSearch);
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', initTilSearch);
  } else {
    initTilSearch();
  }
</script>
